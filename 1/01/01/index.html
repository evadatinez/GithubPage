<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.71.0" />


<title> - Datínez</title>
<meta property="og:title" content=" - Datínez">




  








<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="../../../css/fonts.css" media="all">
<link rel="stylesheet" href="../../../css/main.css" media="all">


  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="../../../" class="nav-logo">
    <img src="../../../images/dlogo4.png"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="../../../about/">About</a></li>
    
    <li><a href="https://github.com/evadatinez">GitHub</a></li>
    
    <li><a href="https://www.linkedin.com/in/emartiro/">LinkedIn</a></li>
    
    <li><a href="https://twitter.com/evadatinez">Twitter</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">23 min read</span>
    

    <h1 class="article-title"></h1>

    
    <span class="article-date">0001/01/01</span>
    

    <div class="article-content">
      <h1 id="bayesian-ab-testing---solving-explore-vs-exploit-dilemma-with-python">Bayesian A/B Testing - Solving Explore vs Exploit Dilemma with Python</h1>
<p>Lately, I have been on maternity leave and people kept saying to me &ldquo;sleep when the baby sleeps&rdquo; but then after surviving the first months I thought &ldquo;yeah&hellip; cook when the baby cooks, develop your career when the baby develops his/her career?&quot;. Then, I have been using the short breaks my baby gives me (plus some extra time during the weekends thanks to my amazingly encouraging husband) to read a bit more about (Bayesian) A/B testing and I have taken an interesting online course:</p>
<blockquote>
<p><a href="https://www.udemy.com/course/bayesian-machine-learning-in-python-ab-testing/">Bayesian Machine Learning in Python: A/B Testing</a></p>
</blockquote>
<p>This blogpost is summarizes what I have learnt in the course.</p>
<p>The course introduces A/B testing in the &ldquo;traditional&rdquo; (frequentist) way and then discusses the Bayesian A/B testing by solving the Explore vs Exploit Dilemma. Everything is implemented in Python. In this blogpost I am not going to develop all the details. I will focus on the Explore vs Exploit Dilemma, introduce and compare the performance of the 3 algorithms shown in the course with the example of advertisement Click-Through Rate, also using Python.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">from</span> scipy <span style="color:#f92672">import</span> stats
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns
sns<span style="color:#f92672">.</span>set_style(<span style="color:#e6db74">&#39;darkgrid&#39;</span>, {<span style="color:#e6db74">&#39;axes.facecolor&#39;</span>: <span style="color:#e6db74">&#39;.9&#39;</span>})
sns<span style="color:#f92672">.</span>set_palette(palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Paired&#39;</span>)
<span style="color:#f92672">%</span>matplotlib inline

<span style="color:#75715e"># Set global plot parameters </span>
plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;figure.figsize&#39;</span>] <span style="color:#f92672">=</span> [<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">6</span>]
plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;figure.dpi&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>
</code></pre></div><h2 id="the-example---advertisement-click-through-rate">The Example - Advertisement Click-Through Rate</h2>
<p>This is the example developed in the course which we will also use all over to illustrate the concepts we will introduce.</p>
<p>Imagine you want to test the performance of 2 advertisements, say ad $A$ and ad $B$. Picture them, they look the same except for 1 feature (e.g. color/shape of the &ldquo;button&rdquo; linking to your page, picture displayed, text of the ad,&hellip;) which you modify with the goal to improve the proportion of users that click on the ad when they see it, i.e. the <em>Click-Through Rate</em> (CTR).</p>
<p>First of all, you would create a business case where you compare the &ldquo;resources needed&rdquo; to implement the test and the expected/desired gain, so that you evaluate whether it is worth investing time and resources (i.e. €€).</p>
<p>Once it is clear you want to move forward with the A/B test, you could do it the &ldquo;traditional way&rdquo;. That means you use a sample size calculator, split your traffic (for example 50%-50% so that half of your traffic will be exposed to ad A and the other half to ad B) and let it run until you collect enough data. Then, depending on the &ldquo;shape&rdquo; of your data (i.e. the distribution) you will run an hypothesis test (for Bernoulli distributed data, i.e. counting data, you would go for a Chi-square test). Finally, if the p-value is less than some significance level of your choice (tipically 0.05, but sometimes also 0.01), then you reject the null hypothesis and conclude one is significantly better than the other.</p>
<p>I have created an example dataset by generating 1000 samples from a Bernouilli distribution with pre-fixed mean (0.51 for ad A and 0.31 for ad B), put them together in a dataframe and shuffling the rows to sort them randomly, as shown below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">0</span>)

N <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000</span>
real_mean_a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.51</span>
real_mean_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.31</span>

random_ad_a <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>binomial(<span style="color:#ae81ff">1</span>, real_mean_a, N)
random_ad_b <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>binomial(<span style="color:#ae81ff">1</span>, real_mean_b, N)

ads_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;A&#39;</span>: random_ad_a, <span style="color:#e6db74">&#39;B&#39;</span>: random_ad_b})<span style="color:#f92672">.</span>melt()
ads_df<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;advertisement_id&#39;</span>, <span style="color:#e6db74">&#39;action&#39;</span>]
ads_df<span style="color:#f92672">.</span>head()
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># set frac = 1 to shuffle the whole set of rows</span>
<span style="color:#75715e"># set random_state = 1 for reproducibility</span>
df_shuffled <span style="color:#f92672">=</span> ads_df<span style="color:#f92672">.</span>sample(frac<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, random_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True)

df_shuffled<span style="color:#f92672">.</span>head()
</code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">alg_comp_in_df <span style="color:#f92672">=</span> df_shuffled<span style="color:#f92672">.</span>copy()
ad_a <span style="color:#f92672">=</span> alg_comp_in_df[alg_comp_in_df[<span style="color:#e6db74">&#39;advertisement_id&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;A&#39;</span>][<span style="color:#e6db74">&#39;action&#39;</span>]<span style="color:#f92672">.</span>values
ad_b <span style="color:#f92672">=</span> alg_comp_in_df[alg_comp_in_df[<span style="color:#e6db74">&#39;advertisement_id&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;B&#39;</span>][<span style="color:#e6db74">&#39;action&#39;</span>]<span style="color:#f92672">.</span>values

A_click <span style="color:#f92672">=</span> sum(ad_a)
A_noclick <span style="color:#f92672">=</span> len(ad_a) <span style="color:#f92672">-</span> A_click
B_click <span style="color:#f92672">=</span> sum(ad_b)
B_noclick <span style="color:#f92672">=</span> len(ad_b) <span style="color:#f92672">-</span> B_click

collected_mean_a <span style="color:#f92672">=</span> ad_a<span style="color:#f92672">.</span>mean()
collected_mean_b <span style="color:#f92672">=</span> ad_b<span style="color:#f92672">.</span>mean()

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;len_a:&#39;</span>, len(ad_a), <span style="color:#e6db74">&#39;, A_click:&#39;</span>, A_click, <span style="color:#e6db74">&#39;, collected_mean_a:&#39;</span>, collected_mean_a, <span style="color:#e6db74">&#39;, real_mean_a:&#39;</span>, real_mean_a)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;len_b:&#39;</span>, len(ad_b), <span style="color:#e6db74">&#39;, B_click:&#39;</span>, B_click, <span style="color:#e6db74">&#39;, collected_mean_b:&#39;</span>, collected_mean_b, <span style="color:#e6db74">&#39;, real_mean_b:&#39;</span>, real_mean_b)
</code></pre></div><pre><code>len_a: 2000 , A_click: 1015 , collected_mean_a: 0.5075 , real_mean_a: 0.51
len_b: 2000 , B_click: 606 , collected_mean_b: 0.303 , real_mean_b: 0.31
</code></pre>
<p>Below you see an example on how one would evaluate this data in a frequentist way, using a <a href="https://en.wikipedia.org/wiki/Chi-squared_test">Chi-squared</a> test.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">T <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([[A_click, A_noclick], [B_click, B_noclick]])

chi2, p, dof, expected <span style="color:#f92672">=</span> stats<span style="color:#f92672">.</span>chi2_contingency( T )
msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;p-value: {}&#39;</span>
<span style="color:#66d9ef">print</span>( msg<span style="color:#f92672">.</span>format(p) )
</code></pre></div><pre><code>p-value: 1.9375629625827686e-39
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">if</span> p <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.05</span>:
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Reject null hypothesis: There is statistically significant difference between the groups&#34;</span>)
<span style="color:#66d9ef">else</span>:
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Cannot reject null hypothesis&#34;</span>)
</code></pre></div><pre><code>Reject null hypothesis: There is statistically significant difference between the groups
</code></pre>
<h2 id="the-explore-vs-exploit-dilemma">The Explore vs Exploit Dilemma</h2>
<p>When I was first introduced to bayesian A/B testing, we were running the tests similar to the frequentist way, i.e. letting run the test for an amount of time and afterwards using the collected data to sample from the distributions and comparing &ldquo;how much better one version was over the other one&rdquo;.</p>
<p>Let us see it using the data I simulated above. The clicks follow a Bernoulli distribution which is a conjugated distribution to a Beta distribution with parameters $a = 1 + #\rm{successes}$ and $b = 1 + #\rm{failures}$ (see <a href="https://en.wikipedia.org/wiki/Conjugate_prior#When_likelihood_function_is_a_discrete_distribution">Wikipedia</a>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># parameters beta for ad A</span>
aA <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> A_click
bA <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> A_noclick
<span style="color:#75715e"># parameters beta for ad B</span>
aB <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> B_click
bB <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> B_noclick
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">M <span style="color:#f92672">=</span> <span style="color:#ae81ff">3000</span>
samples_A <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>beta(aA, bA, M)
samples_B <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>beta(aB, bB, M)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots()
sns<span style="color:#f92672">.</span>distplot(a<span style="color:#f92672">=</span>samples_A, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;A&#39;</span>, ax<span style="color:#f92672">=</span>ax)
sns<span style="color:#f92672">.</span>distplot(a<span style="color:#f92672">=</span>samples_B, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;B&#39;</span>, ax<span style="color:#f92672">=</span>ax)
ax<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>real_mean_a, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;grey&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
ax<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>real_mean_b, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Ads CTR distributions&#39;</span>)
ax<span style="color:#f92672">.</span>legend(
    loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center left&#39;</span>, 
    bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>), 
    labels<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Real CTR A&#39;</span>, <span style="color:#e6db74">&#39;Real CTR B&#39;</span>, <span style="color:#e6db74">&#39;Distribution of Ad A&#39;</span>, <span style="color:#e6db74">&#39;Distribution of Ad B&#39;</span>]
)
plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#39;plots/distributions_samples.png&#39;</span>, dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>, bbox_inches<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tight&#39;</span>);
</code></pre></div><p><img src="blogpost_files/blogpost_13_0.svg" alt="svg"></p>
<p>With the distributions of the CTR of the Ads it is quite evident that the ad A has performed much better than ad B. In any case one can measure &ldquo;how buch better&rdquo; is the performance of A with respect to B by sampling from the samples and calculating the probability that ad A is better than ad B as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">delta_A_B_sample <span style="color:#f92672">=</span> []
MM <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(MM):
    condition <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(samples_A) <span style="color:#f92672">&gt;</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(samples_B)
    delta_A_B_sample<span style="color:#f92672">.</span>append(condition)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;The probability that ad A is better than ad B is&#39;</span>, np<span style="color:#f92672">.</span>array(delta_A_B_sample)<span style="color:#f92672">.</span>mean())
</code></pre></div><pre><code>The probability that ad A is better than ad B is 1.0
</code></pre>
<p>A natural question arises:</p>
<blockquote>
<p>If I see that ad A is performing better, can I stop my experiment and just show ad A?</p>
</blockquote>
<p>To reach a point on which this question makes sense, you first need to show both advertisements (both the &ldquo;good&rdquo; and the &ldquo;bad&rdquo; ones) and analyze their performance. Eventually, you can use the information you have to show more often the ad that performs better. But how much should I show each add (<strong>Explore</strong>) vs should I just show the better performing ad (<strong>Exploit</strong>)? This is the so-called <strong>Explore-Exploit Dilemma</strong>.</p>
<p>In the <a href="https://www.udemy.com/course/bayesian-machine-learning-in-python-ab-testing/">course</a>, 3 different algorithms are shown to solve this problem (only the last one is Bayesian). The rest of this post is devoted to introduce these algorithms and compare their performance with the data I simulated above. First I will introduce the logic of each method and then I will illustrate them via a the simulation data generated above.</p>
<h2 id="solving-the-explore-vs-exploit-dilemma">Solving the Explore vs Exploit Dilemma</h2>
<h3 id="strategy-i-epsilon---greedy">Strategy I: Epsilon - Greedy</h3>
<p>The Epsilon - Greedy algorithm is an intuitive way to solve the Explore-Exploit dilemma.</p>
<p>In the algorithm you choose a small number ($\epsilon$) between $0$ and $1$, which will be the probability of exploration.</p>
<pre><code>eps = 0.1
while True:
    r = rand()
    if r &lt; eps:
        # explore
        show random ad 
    else:
        # exploit 
        show best ad (as determined by #clicks / #impressions)
</code></pre><p>One issue is that even when A is significantly better than B, it will still sometimes choose B.</p>
<p>Let us assume we had $N$ impressions, with $\rm{reward}(\rm{Click}) = 1$, $\rm{reward}(\rm{noClick}) = 0$.</p>
<p>If we consider the extreme case where A always yields a click, and B always yields 0, we have that we show ad B 50% of the times that the random number $r$ was $r &lt; \epsilon$, i.e. the expected loss is $\epsilon N / 2$.</p>
<p>Hence, for $\epsilon = 0.1$, we loose $0.05N$. Nevertheless, this is still better than traditional A/B test with no adaptation, where you would loose $0.5N$.</p>
<h3 id="strategy-ii-ucb1">Strategy II: UCB1</h3>
<p><a href="https://link.springer.com/content/pdf/10.1023/A:1013689704352.pdf">UCB</a> stands for <em>Upper Confidence Bound</em>. I have seen it several times phrased as <em>optimism in the face of uncertainty</em>.</p>
<p>The main idea of the algorithm is to construct a confidence interval of what each ad’s true performance might be. Then, the algorithm selects the ad with the highest UCB. This is why &ldquo;optimism&rdquo;, because one is assuming the ad will behave as well as its UCB. It kind of makes sense because at the end of the day we are trying to find the ad with the highest CTR.</p>
<p>What is this bound? The <strong><a href="https://en.wikipedia.org/wiki/Hoeffding%27s_inequality">Chernoff-Hoeffding bound</a></strong> says:
$$P(\hat\mu &gt; \mu + \epsilon) \leq \rm{exp}(-2\epsilon^{2} N ),$$
for some $\epsilon &gt; 0$, where $N$ denotes the number of observations (i.e. the sample size), $\hat\mu$ denotes the true CTR (mean) and $\mu$ the sample mean (i.e. the CTR of the data observed so far).</p>
<p>For each ad $j = A,B$, we want to pick a bound $\epsilon_j$ so that the true mean $\hat\mu_j &lt; \mu_j + \epsilon_j$. Thus, $\rm{exp}(-2\epsilon_j^{2} N )$ should be a small probability.<br>
Say we set a threshold $p_j$, i.e. $p_j = \rm{exp}(-2\epsilon_j^{2} N_j )$. Then,
$$ \epsilon_j = \sqrt{-\dfrac{\log p_j}{2 N_j}}$$
and we can set $p_j = N^{-4}$ so that we obtain the epsilon:
$$\epsilon_j = \sqrt{\dfrac{2\log N}{N_j}}$$
where $N$ is the total number of ads displayed and $N_j$ the number of times that ad $j$ was displayed.</p>
<p>The discussion above is explained very nicely in <a href="https://lilianweng.github.io/lil-log/2018/01/23/the-multi-armed-bandit-problem-and-its-solutions.html#hoeffdings-inequality">Lilian Weng’s blog</a>.</p>
<p>Now the algorithm is as follows:</p>
<pre><code>N = 0
Nj = 0 for all bandits j 
while True:
    j* = argmax(mu_j + sqrt(2log(N) / Nj))

    Show ad j*
    Update mu_j*
    N++
    Nj*++
</code></pre><p>Let us observe closely the term <code>j* = argmax(mu_j + sqrt(2log(N) / Nj))</code>:</p>
<ul>
<li>the first term is the CTR estimate (if high, we exploit more often)</li>
<li>the second term depends on $N$ and $N_j$ (so if $N$ is high, but $N_j$ is low, we are not so confident about the $CTR_j$ so we explore this more).</li>
</ul>
<p>It can be shown that the expected loss is proportional to $\log(N)$ (<a href="https://link.springer.com/content/pdf/10.1023/A:1013689704352.pdf">see Theorem 1 on this paper</a>).</p>
<p>Compared to the Epsilon-Greedy algorithm whose loss is proportional to $N$, in the long run UCB1 will perform much better.</p>
<h3 id="strategy-iii-bayesian">Strategy III: Bayesian</h3>
<p>This method is also called <a href="https://en.wikipedia.org/wiki/Thompson_sampling">Thompson sampling</a>. This technique aims to perform actions to maximize the cumulative rewards.</p>
<p>It basically draws samples from the current posterior distribution of all the ads with the data observed so far and exploits the one giving the greatest sample value. Conceptually, we are trusting that we are exploiting the ad which will provide the highgest reward.</p>
<p>Then, the algorithm reads:</p>
<pre><code>while True:
    Draw a random sample from all ads' current Beta(aj, bj)
    j* = ad that gives us maximum sample
    x = show ad j*
    aj* = aj* + x
    bj* = bj* + 1 - x
</code></pre><p>In most practical applications, it can be quite computationally expensive to estimate posterior distributions using Bayesian inference, so in general this technique comes together with approximate sampling techniques. I recommend <a href="https://arxiv.org/pdf/1707.02038.pdf">this tutorial</a> to learn more about thompson sampling.</p>
<h3 id="comparison-of-the-different-strategies">Comparison of the different strategies</h3>
<p>In this section I have implemented and compared the 3 algorithms introduced above.</p>
<p>We want to answer the following questions:</p>
<ul>
<li>Which method converged to the best advertisement the fastest?</li>
<li>What is the total loss compared to what you would have gotten if you already knew which the best advertisement was and displayed only that ad every time?</li>
</ul>
<p>The instructor of the course provided a script to simulate the process of running an http web service using <code>flask</code>, just like a real website, to treat the data generated above (and stored in a <code>.csv</code> file) like real-time data. For simplicity here I show a iterative direct implementation.</p>
<p>I first define a class <code>Advertisement</code> whose attributes are its own name, the values <code>1/0</code> of <code>click/no click</code> from the input dataframe, and then a bunch of attributes with the shape <code>clicks_method_name</code> (resp. <code>views_method_name</code>) to record the clicks (resp. views/impressions) where <code>method_name</code> will be each algorithm we will be comparing:</p>
<ul>
<li><code>no_adapt</code> i.e. no adaptation, displaying random add with 50% split</li>
<li><code>eps</code> i.e. Epsilon-Greedy algorithm</li>
<li><code>ucb1</code> i.e. UCB1 algorithm</li>
<li><code>bay</code> i.e. Bayesian (Thompson) algorithm</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Advertisement</span>:
    <span style="color:#66d9ef">def</span> __init__(self, name, df):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        <span style="color:#75715e"># values 1/0 of click/no click</span>
        adv <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;advertisement_id&#39;</span>] <span style="color:#f92672">==</span> name]
        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> adv[<span style="color:#e6db74">&#39;action&#39;</span>]<span style="color:#f92672">.</span>values
        <span style="color:#75715e"># No adaptation</span>
        self<span style="color:#f92672">.</span>clicks_no_adapt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>views_no_adapt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#75715e"># Epsilon-Greedy</span>
        self<span style="color:#f92672">.</span>clicks_eps <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>views_eps <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#75715e"># UCB1</span>
        self<span style="color:#f92672">.</span>clicks_ucb1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>views_ucb1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#75715e"># Bayesian</span>
        self<span style="color:#f92672">.</span>clicks_bay <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>views_bay <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sample</span>(self):
        <span style="color:#75715e"># only in bayesian method</span>
        a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>clicks_bay
        b <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>views_bay <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>clicks_bay
        <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>beta(a, b)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_click</span>(self, method_name):
        <span style="color:#66d9ef">if</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;no_adapt&#39;</span>:
            self<span style="color:#f92672">.</span>clicks_no_adapt <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;epsilon&#39;</span>:
            self<span style="color:#f92672">.</span>clicks_eps <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ucb1&#39;</span>:
            self<span style="color:#f92672">.</span>clicks_ucb1 <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;bayesian&#39;</span>:
            self<span style="color:#f92672">.</span>clicks_bay <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_view</span>(self, method_name):
        <span style="color:#66d9ef">if</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;no_adapt&#39;</span>:
            self<span style="color:#f92672">.</span>views_no_adapt <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;epsilon&#39;</span>:
            self<span style="color:#f92672">.</span>views_eps <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ucb1&#39;</span>:
            self<span style="color:#f92672">.</span>views_ucb1 <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;bayesian&#39;</span>:
            self<span style="color:#f92672">.</span>views_bay <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</code></pre></div><p>Next, we need functions to act as a server request, returning the advertisement to be displayed. I create one for each method.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_no_adapt</span>(ads, p<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Returns random ad to display with split 100*p / 100-(100*p) %.&#34;&#34;&#34;</span>
    ad_a, ad_b <span style="color:#f92672">=</span> ads
    <span style="color:#75715e"># show random ad 100*p % / 100-(100*p) %</span>
    random_ad <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>binomial(<span style="color:#ae81ff">1</span>, p)
    <span style="color:#66d9ef">if</span>(random_ad <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
        ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>
        ad_a<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;no_adapt&#39;</span>)
    <span style="color:#66d9ef">else</span>:
        ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;B&#39;</span>
        ad_b<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;no_adapt&#39;</span>)

    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;advertisement_id&#39;</span>: ad, <span style="color:#e6db74">&#39;method_name&#39;</span>: <span style="color:#e6db74">&#39;no_adapt&#39;</span>}


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_epsilon</span>(ads, eps<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>):
    <span style="color:#e6db74">&#34;&#34;&#34;Returns ad to display using Epsilon-Greedy algorithm.&#34;&#34;&#34;</span>
    ad_a, ad_b <span style="color:#f92672">=</span> ads
    <span style="color:#75715e"># create random number between 0 and 1</span>
    r <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>random()
    <span style="color:#66d9ef">if</span> r <span style="color:#f92672">&lt;</span> eps <span style="color:#f92672">or</span> ad_a<span style="color:#f92672">.</span>views_eps<span style="color:#f92672">*</span>ad_b<span style="color:#f92672">.</span>views_eps <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#75715e"># show random ad</span>
        random_ad <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>binomial(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>)
        <span style="color:#66d9ef">if</span>(random_ad <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
            ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>
            ad_a<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;epsilon&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;B&#39;</span>
            ad_b<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;epsilon&#39;</span>)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#75715e"># show best add</span>
        <span style="color:#66d9ef">if</span> ad_a<span style="color:#f92672">.</span>clicks_eps<span style="color:#f92672">/</span>ad_a<span style="color:#f92672">.</span>views_eps <span style="color:#f92672">&gt;</span> \
                ad_b<span style="color:#f92672">.</span>clicks_eps<span style="color:#f92672">/</span>ad_b<span style="color:#f92672">.</span>views_eps:
            ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>
            ad_a<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;epsilon&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;B&#39;</span>
            ad_b<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;epsilon&#39;</span>)

    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;advertisement_id&#39;</span>: ad, <span style="color:#e6db74">&#39;method_name&#39;</span>: <span style="color:#e6db74">&#39;epsilon&#39;</span>}


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_ucb1</span>(ads):
    <span style="color:#e6db74">&#34;&#34;&#34;Returns ad to display using UCB1 algorithm.&#34;&#34;&#34;</span>
    ad_a, ad_b <span style="color:#f92672">=</span> ads
    cA <span style="color:#f92672">=</span> ad_a<span style="color:#f92672">.</span>clicks_ucb1
    vA <span style="color:#f92672">=</span> ad_a<span style="color:#f92672">.</span>views_ucb1
    cB <span style="color:#f92672">=</span> ad_b<span style="color:#f92672">.</span>clicks_ucb1
    vB <span style="color:#f92672">=</span> ad_b<span style="color:#f92672">.</span>views_ucb1
    <span style="color:#66d9ef">if</span> vA<span style="color:#f92672">*</span>vB <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#75715e"># show random ad</span>
        random_ad <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>binomial(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>)
        <span style="color:#66d9ef">if</span>(random_ad <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
            ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>
            ad_a<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;ucb1&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;B&#39;</span>
            ad_b<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;ucb1&#39;</span>)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#75715e"># calculate mu_j + eps_j for each bandit j</span>
        <span style="color:#75715e"># i.e. mu_j + sqrt(2ln(N) / Nj)</span>
        jA <span style="color:#f92672">=</span> cA<span style="color:#f92672">/</span>vA <span style="color:#f92672">+</span> np<span style="color:#f92672">.</span>sqrt(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>log(vA <span style="color:#f92672">+</span> vB)<span style="color:#f92672">/</span>vA)
        jB <span style="color:#f92672">=</span> cB<span style="color:#f92672">/</span>vB <span style="color:#f92672">+</span> np<span style="color:#f92672">.</span>sqrt(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>log(vA <span style="color:#f92672">+</span> vB)<span style="color:#f92672">/</span>vB)

        <span style="color:#75715e"># show best add</span>
        <span style="color:#66d9ef">if</span> jA <span style="color:#f92672">&gt;</span> jB:
            ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>
            ad_a<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;ucb1&#39;</span>)
        <span style="color:#66d9ef">else</span>:
            ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;B&#39;</span>
            ad_b<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;ucb1&#39;</span>)

    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;advertisement_id&#39;</span>: ad, <span style="color:#e6db74">&#39;method_name&#39;</span>: <span style="color:#e6db74">&#39;ucb1&#39;</span>}


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_bayesian</span>(ads):
    <span style="color:#e6db74">&#34;&#34;&#34;Returns ad to display using Bayesian (Thompson) algorithm.&#34;&#34;&#34;</span>
    ad_a, ad_b <span style="color:#f92672">=</span> ads
    sample_a <span style="color:#f92672">=</span> ad_a<span style="color:#f92672">.</span>sample()
    sample_b <span style="color:#f92672">=</span> ad_b<span style="color:#f92672">.</span>sample()
    <span style="color:#66d9ef">if</span> sample_a <span style="color:#f92672">&gt;</span> sample_b:
        ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>
        ad_a<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;bayesian&#39;</span>)
    <span style="color:#66d9ef">else</span>:
        ad <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;B&#39;</span>
        ad_b<span style="color:#f92672">.</span>add_view(<span style="color:#e6db74">&#39;bayesian&#39;</span>)
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;advertisement_id&#39;</span>: ad, <span style="color:#e6db74">&#39;method_name&#39;</span>: <span style="color:#e6db74">&#39;bayesian&#39;</span>}


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">request_ad</span>(method_name, ads):
    <span style="color:#e6db74">&#34;&#34;&#34;Calls request function according to method name.&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;no_adapt&#39;</span>:
        <span style="color:#66d9ef">return</span> request_no_adapt(ads, <span style="color:#ae81ff">0.5</span>)
    <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;epsilon&#39;</span>:
        <span style="color:#66d9ef">return</span> request_epsilon(ads, <span style="color:#ae81ff">0.1</span>)
    <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ucb1&#39;</span>:
        <span style="color:#66d9ef">return</span> request_ucb1(ads)
    <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;bayesian&#39;</span>:
        <span style="color:#66d9ef">return</span> request_bayesian(ads)
    <span style="color:#75715e"># for debugging purposes</span>
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;No request method found&#39;</span>
</code></pre></div><p>We also need a function to check in our dataset whether the ad should be clicked when displayed and updates its clicks data accordingly.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click_ad</span>(method_name, ad):
    <span style="color:#e6db74">&#34;&#34;&#34;Records click ad according to dataset input.&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;no_adapt&#39;</span>:
        views <span style="color:#f92672">=</span> ad<span style="color:#f92672">.</span>views_no_adapt
    <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;epsilon&#39;</span>:
        views <span style="color:#f92672">=</span> ad<span style="color:#f92672">.</span>views_eps
    <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ucb1&#39;</span>:
        views <span style="color:#f92672">=</span> ad<span style="color:#f92672">.</span>views_ucb1
    <span style="color:#66d9ef">elif</span> method_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;bayesian&#39;</span>:
        views <span style="color:#f92672">=</span> ad<span style="color:#f92672">.</span>views_bay

    action <span style="color:#f92672">=</span> ad<span style="color:#f92672">.</span>data[views]
    <span style="color:#66d9ef">if</span> action <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#75715e"># only click the ad if our dataset determines that we should</span>
        ad<span style="color:#f92672">.</span>add_click(method_name)
        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;advertisement_id&#39;</span>: ad<span style="color:#f92672">.</span>name, <span style="color:#e6db74">&#39;method_name&#39;</span>: method_name}
</code></pre></div><p>Now we are ready to run the process.</p>
<p>First, we have to initialize the variables for the ads, counts and summary list. We will need them to record the data of the advertisements and the different stats we will be interested on.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># initialize advertisements</span>
ad_a <span style="color:#f92672">=</span> Advertisement(<span style="color:#e6db74">&#39;A&#39;</span>, alg_comp_in_df)
ad_b <span style="color:#f92672">=</span> Advertisement(<span style="color:#e6db74">&#39;B&#39;</span>, alg_comp_in_df)

count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

df_list <span style="color:#f92672">=</span> []
</code></pre></div><p>Then, we iterate until there is no data left for either ad for one of the methods.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">while</span> ad_a<span style="color:#f92672">.</span>views_no_adapt <span style="color:#f92672">&lt;</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> ad_b<span style="color:#f92672">.</span>views_no_adapt <span style="color:#f92672">&lt;</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> \
        ad_a<span style="color:#f92672">.</span>views_eps <span style="color:#f92672">&lt;</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> ad_b<span style="color:#f92672">.</span>views_eps <span style="color:#f92672">&lt;</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> \
        ad_a<span style="color:#f92672">.</span>views_ucb1 <span style="color:#f92672">&lt;</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> ad_b<span style="color:#f92672">.</span>views_ucb1 <span style="color:#f92672">&lt;</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> \
        ad_a<span style="color:#f92672">.</span>views_bay <span style="color:#f92672">&lt;</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> ad_b<span style="color:#f92672">.</span>views_bay <span style="color:#f92672">&lt;</span> N <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>:
    <span style="color:#75715e"># quit when there&#39;s no data left for either ad</span>
    <span style="color:#75715e"># no adaptation method</span>
    r_no_adapt <span style="color:#f92672">=</span> request_ad(<span style="color:#e6db74">&#39;no_adapt&#39;</span>, (ad_a, ad_b))
    <span style="color:#66d9ef">if</span> r_no_adapt[<span style="color:#e6db74">&#39;advertisement_id&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;A&#39;</span>:
        click_ad(<span style="color:#e6db74">&#39;no_adapt&#39;</span>, ad_a)
    <span style="color:#66d9ef">else</span>:
        click_ad(<span style="color:#e6db74">&#39;no_adapt&#39;</span>, ad_b)

    <span style="color:#75715e"># epsilon greedy method</span>
    r_eps <span style="color:#f92672">=</span> request_ad(<span style="color:#e6db74">&#39;epsilon&#39;</span>, (ad_a, ad_b))
    <span style="color:#66d9ef">if</span> r_eps[<span style="color:#e6db74">&#39;advertisement_id&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;A&#39;</span>:
        click_ad(<span style="color:#e6db74">&#39;epsilon&#39;</span>, ad_a)
    <span style="color:#66d9ef">else</span>:
        click_ad(<span style="color:#e6db74">&#39;epsilon&#39;</span>, ad_b)

    <span style="color:#75715e"># ucb1 method</span>
    r_ucb1 <span style="color:#f92672">=</span> request_ad(<span style="color:#e6db74">&#39;ucb1&#39;</span>, (ad_a, ad_b))
    <span style="color:#66d9ef">if</span> r_ucb1[<span style="color:#e6db74">&#39;advertisement_id&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;A&#39;</span>:
        click_ad(<span style="color:#e6db74">&#39;ucb1&#39;</span>, ad_a)
    <span style="color:#66d9ef">else</span>:
        click_ad(<span style="color:#e6db74">&#39;ucb1&#39;</span>, ad_b)

    <span style="color:#75715e"># bayesian method</span>
    r_bay <span style="color:#f92672">=</span> request_ad(<span style="color:#e6db74">&#39;bayesian&#39;</span>, (ad_a, ad_b))
    <span style="color:#66d9ef">if</span> r_bay[<span style="color:#e6db74">&#39;advertisement_id&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;A&#39;</span>:
        click_ad(<span style="color:#e6db74">&#39;bayesian&#39;</span>, ad_a)
    <span style="color:#66d9ef">else</span>:
        click_ad(<span style="color:#e6db74">&#39;bayesian&#39;</span>, ad_b)

    <span style="color:#75715e"># log some stats</span>
    count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(np<span style="color:#f92672">.</span>array([[count,
                                ad_a<span style="color:#f92672">.</span>clicks_no_adapt, ad_b<span style="color:#f92672">.</span>clicks_no_adapt,
                                ad_a<span style="color:#f92672">.</span>clicks_eps, ad_b<span style="color:#f92672">.</span>clicks_eps,
                                ad_a<span style="color:#f92672">.</span>clicks_ucb1, ad_b<span style="color:#f92672">.</span>clicks_ucb1,
                                ad_a<span style="color:#f92672">.</span>clicks_bay, ad_b<span style="color:#f92672">.</span>clicks_bay,
                                ad_a<span style="color:#f92672">.</span>views_no_adapt, ad_b<span style="color:#f92672">.</span>views_no_adapt,
                                ad_a<span style="color:#f92672">.</span>views_eps, ad_b<span style="color:#f92672">.</span>views_eps,
                                ad_a<span style="color:#f92672">.</span>views_ucb1, ad_b<span style="color:#f92672">.</span>views_ucb1,
                                ad_a<span style="color:#f92672">.</span>views_bay, ad_b<span style="color:#f92672">.</span>views_bay]]),
                      columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>,
                               <span style="color:#e6db74">&#39;clicksA_no_adapt&#39;</span>, <span style="color:#e6db74">&#39;clicksB_no_adapt&#39;</span>,
                               <span style="color:#e6db74">&#39;clicksA_epsilon&#39;</span>, <span style="color:#e6db74">&#39;clicksB_epsilon&#39;</span>,
                               <span style="color:#e6db74">&#39;clicksA_ucb1&#39;</span>, <span style="color:#e6db74">&#39;clicksB_ucb1&#39;</span>,
                               <span style="color:#e6db74">&#39;clicksA_bayesian&#39;</span>, <span style="color:#e6db74">&#39;clicksB_bayesian&#39;</span>,
                               <span style="color:#e6db74">&#39;viewsA_no_adapt&#39;</span>, <span style="color:#e6db74">&#39;viewsB_no_adapt&#39;</span>,
                               <span style="color:#e6db74">&#39;viewsA_epsilon&#39;</span>, <span style="color:#e6db74">&#39;viewsB_epsilon&#39;</span>,
                               <span style="color:#e6db74">&#39;viewsA_ucb1&#39;</span>, <span style="color:#e6db74">&#39;viewsB_ucb1&#39;</span>,
                               <span style="color:#e6db74">&#39;viewsA_bayesian&#39;</span>, <span style="color:#e6db74">&#39;viewsB_bayesian&#39;</span>
                               ])

    df_list<span style="color:#f92672">.</span>append(df)
</code></pre></div><p>Let us consolidate the stats we have recorded:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Consolidate stats DataFrame</span>
df_final <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat(df_list, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)

<span style="color:#75715e"># Calculate CTRs for each method</span>
<span style="color:#75715e"># No adaptation</span>
df_final[<span style="color:#e6db74">&#39;muA_no_adapt&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(df_final[<span style="color:#e6db74">&#39;viewsA_no_adapt&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
                                    round(df_final[<span style="color:#e6db74">&#39;clicksA_no_adapt&#39;</span>] <span style="color:#f92672">/</span>
                                    df_final[<span style="color:#e6db74">&#39;viewsA_no_adapt&#39;</span>], <span style="color:#ae81ff">3</span>), <span style="color:#ae81ff">0</span>)
df_final[<span style="color:#e6db74">&#39;muB_no_adapt&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(df_final[<span style="color:#e6db74">&#39;viewsB_no_adapt&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
                                    round(df_final[<span style="color:#e6db74">&#39;clicksB_no_adapt&#39;</span>] <span style="color:#f92672">/</span>
                                    df_final[<span style="color:#e6db74">&#39;viewsB_no_adapt&#39;</span>], <span style="color:#ae81ff">3</span>), <span style="color:#ae81ff">0</span>)

<span style="color:#75715e"># Epsilon-Greedy algorithm</span>
df_final[<span style="color:#e6db74">&#39;muA_epsilon&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(df_final[<span style="color:#e6db74">&#39;viewsA_epsilon&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
                               round(df_final[<span style="color:#e6db74">&#39;clicksA_epsilon&#39;</span>] <span style="color:#f92672">/</span>
                               df_final[<span style="color:#e6db74">&#39;viewsA_epsilon&#39;</span>], <span style="color:#ae81ff">3</span>), <span style="color:#ae81ff">0</span>)
df_final[<span style="color:#e6db74">&#39;muB_epsilon&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(df_final[<span style="color:#e6db74">&#39;viewsB_epsilon&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
                               round(df_final[<span style="color:#e6db74">&#39;clicksB_epsilon&#39;</span>] <span style="color:#f92672">/</span>
                               df_final[<span style="color:#e6db74">&#39;viewsB_epsilon&#39;</span>], <span style="color:#ae81ff">3</span>), <span style="color:#ae81ff">0</span>)

<span style="color:#75715e"># UCB1 algorithm</span>
df_final[<span style="color:#e6db74">&#39;muA_ucb1&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(df_final[<span style="color:#e6db74">&#39;viewsA_ucb1&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
                                round(df_final[<span style="color:#e6db74">&#39;clicksA_ucb1&#39;</span>] <span style="color:#f92672">/</span>
                                df_final[<span style="color:#e6db74">&#39;viewsA_ucb1&#39;</span>], <span style="color:#ae81ff">3</span>), <span style="color:#ae81ff">0</span>)
df_final[<span style="color:#e6db74">&#39;muB_ucb1&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(df_final[<span style="color:#e6db74">&#39;viewsB_ucb1&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
                                round(df_final[<span style="color:#e6db74">&#39;clicksB_ucb1&#39;</span>] <span style="color:#f92672">/</span>
                                df_final[<span style="color:#e6db74">&#39;viewsB_ucb1&#39;</span>], <span style="color:#ae81ff">3</span>), <span style="color:#ae81ff">0</span>)

<span style="color:#75715e"># Bayesian (Thompson) algorithm</span>
df_final[<span style="color:#e6db74">&#39;muA_bayesian&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(df_final[<span style="color:#e6db74">&#39;viewsA_bayesian&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
                                    round(df_final[<span style="color:#e6db74">&#39;clicksA_bayesian&#39;</span>] <span style="color:#f92672">/</span>
                                    df_final[<span style="color:#e6db74">&#39;viewsA_bayesian&#39;</span>], <span style="color:#ae81ff">3</span>), <span style="color:#ae81ff">0</span>)
df_final[<span style="color:#e6db74">&#39;muB_bayesian&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(df_final[<span style="color:#e6db74">&#39;viewsB_bayesian&#39;</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>,
                                    round(df_final[<span style="color:#e6db74">&#39;clicksB_bayesian&#39;</span>] <span style="color:#f92672">/</span>
                                    df_final[<span style="color:#e6db74">&#39;viewsB_bayesian&#39;</span>], <span style="color:#ae81ff">3</span>), <span style="color:#ae81ff">0</span>)

alg_comp_out_df <span style="color:#f92672">=</span> df_final<span style="color:#f92672">.</span>copy()
</code></pre></div><p>The first thing we can do is to observe the evolution of the distributions over time. For this, I have implemented a function to plot the ads distributions iteratively at a certain step.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot</span>(df_rn, vars_data, i):
    <span style="color:#e6db74">&#34;&#34;&#34; Plots the ads distributions given by vars_data.
</span><span style="color:#e6db74">    If i&gt;=0, it saves a .png file with iterative file name.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots()
    x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">200</span>)
    <span style="color:#66d9ef">for</span> velt <span style="color:#f92672">in</span> vars_data:
        clicks_col, views_col, ad, method <span style="color:#f92672">=</span> velt
        a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> df_rn[clicks_col]
        b <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> df_rn[views_col] <span style="color:#f92672">-</span> df_rn[clicks_col]
        y <span style="color:#f92672">=</span> stats<span style="color:#f92672">.</span>beta<span style="color:#f92672">.</span>pdf(x, a, b)
        plt<span style="color:#f92672">.</span>plot(x, y, label<span style="color:#f92672">=</span>ad <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">+</span> method)

    ax<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>real_mean_a, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;grey&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Real CTR A&#39;</span>)
    ax<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>real_mean_b, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Real CTR B&#39;</span>)
    plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Ads distributions after </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> views&#39;</span> <span style="color:#f92672">%</span> df_rn[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>])
    plt<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center left&#39;</span>, bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>))
    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#75715e"># if i &gt;=0, save the plot in .png format</span>
        <span style="color:#75715e"># clean the index to get iterative filename</span>
        index <span style="color:#f92672">=</span> i
        <span style="color:#66d9ef">if</span> index <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>:
            index <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">+</span> str(i)
        plt<span style="color:#f92672">.</span>savefig(f<span style="color:#e6db74">&#39;plots/plot_ads_dist/plot_{index}.png&#39;</span>, dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>, bbox_inches<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tight&#39;</span>)
    
    plt<span style="color:#f92672">.</span>show()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">vars_data <span style="color:#f92672">=</span> [
    [<span style="color:#e6db74">&#39;clicksA_no_adapt&#39;</span>, <span style="color:#e6db74">&#39;viewsA_no_adapt&#39;</span>, <span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;no_adapt&#39;</span>],
    [<span style="color:#e6db74">&#39;clicksB_no_adapt&#39;</span>, <span style="color:#e6db74">&#39;viewsB_no_adapt&#39;</span>, <span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">&#39;no_adapt&#39;</span>],
    [<span style="color:#e6db74">&#39;clicksA_epsilon&#39;</span>, <span style="color:#e6db74">&#39;viewsA_epsilon&#39;</span>, <span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;epsilon&#39;</span>],
    [<span style="color:#e6db74">&#39;clicksB_epsilon&#39;</span>, <span style="color:#e6db74">&#39;viewsB_epsilon&#39;</span>, <span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">&#39;epsilon&#39;</span>],
    [<span style="color:#e6db74">&#39;clicksA_ucb1&#39;</span>, <span style="color:#e6db74">&#39;viewsA_ucb1&#39;</span>, <span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;ucb1&#39;</span>],
    [<span style="color:#e6db74">&#39;clicksB_ucb1&#39;</span>, <span style="color:#e6db74">&#39;viewsB_ucb1&#39;</span>, <span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">&#39;ucb1&#39;</span>],
    [<span style="color:#e6db74">&#39;clicksA_bayesian&#39;</span>, <span style="color:#e6db74">&#39;viewsA_bayesian&#39;</span>, <span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;bayesian&#39;</span>],
    [<span style="color:#e6db74">&#39;clicksB_bayesian&#39;</span>, <span style="color:#e6db74">&#39;viewsB_bayesian&#39;</span>, <span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">&#39;bayesian&#39;</span>]
]
</code></pre></div><p>I have defined a list <code>plot_points</code> with the steps I want to plot, i.e. to plot the distributions after $x$ number of views. The code below shows how I iterate through this list to plot each step. The result is a bunch of plots that I have transformed into a <code>.gif</code> file, using <code>ImageMagik</code>, with the bash command below. I have learnt to do it on a mac from this post: <a href="https://stackoverflow.com/questions/20126812/mac-terminal-create-animated-gif-from-png-files">create .gif from .png files</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plot_points <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">500</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">1500</span>, alg_comp_out_df<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]]
<span style="color:#66d9ef">for</span> i, plot_pt <span style="color:#f92672">in</span> enumerate(plot_points):
    df_rn <span style="color:#f92672">=</span> alg_comp_out_df<span style="color:#f92672">.</span>iloc[plot_pt <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
    plot(df_rn, vars_data, i)
</code></pre></div><p><img src="blogpost_files/blogpost_35_0.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_1.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_2.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_3.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_4.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_5.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_6.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_7.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_8.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_9.svg" alt="svg"></p>
<p><img src="blogpost_files/blogpost_35_10.svg" alt="svg"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%%bash
convert -delay <span style="color:#ae81ff">100</span> plots/plot_ads_dist/*.png plots/distributions.gif
</code></pre></div><p>We observe that:</p>
<ul>
<li>After 20 views, ad A sems to be underperforming in all algorithms.</li>
<li>After 50 views, it seems like ad A, with UCB1 and no adaptation are much closer to reality but with Epsilon-Greedy and Bayesian it is still underperforming.</li>
<li>After 100 views, all algorithms except Epsilon-Greedy are close to the real distribution of ad A.</li>
<li>After 500 views, all algorithms have captured the real distribution of the CTR for ad A.</li>
<li>Finally, after finishing the experiment (after 2045 views), all distributions of ad A have converged around the real CTR of A except no adaptation, which seems to be a bit higher than the rest. Here the most interesting thing is regarding ad B, where the height of its distribution is exactly as expected. Below, I sort the results from worst to best:
<ul>
<li>No adaptation is the one that has explored ad B the most and therefore is closer to the real CTR of ad B.</li>
<li>Expsilon - Greedy</li>
<li>UCB1</li>
<li>Bayesian (Thompson) is the one that has explored ad B the least and therefore the distribution is wider and farther from the real CTR.</li>
</ul>
</li>
</ul>
<p>As you can see, the last plot is worth observing it carefully, I include it statically below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df_rn <span style="color:#f92672">=</span> alg_comp_out_df<span style="color:#f92672">.</span>iloc[alg_comp_out_df<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
plot(df_rn, vars_data, i<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
</code></pre></div><p><img src="blogpost_files/blogpost_39_0.svg" alt="svg"></p>
<p>Another interesting thing to plot is the CTR (referenced as Calculated CTR) over ad request number, to see how far/close they converge to the real CTR and compare how fast is this convergence.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">12</span>))

<span style="color:#75715e"># No adaptation</span>
dg_eps <span style="color:#f92672">=</span> alg_comp_out_df \
    [[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>, <span style="color:#e6db74">&#39;muA_no_adapt&#39;</span>, <span style="color:#e6db74">&#39;muB_no_adapt&#39;</span>]] \
    <span style="color:#f92672">.</span>melt(id_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ad_request_num&#39;</span>) \
    <span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;variable&#39;</span>: <span style="color:#e6db74">&#39;Calculated CTR&#39;</span>})

ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>real_mean_a, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;grey&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>real_mean_b, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
sns<span style="color:#f92672">.</span>lineplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ad_request_num&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;value&#39;</span>, data<span style="color:#f92672">=</span>dg_eps, ax<span style="color:#f92672">=</span>ax[<span style="color:#ae81ff">0</span>], hue<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Calculated CTR&#39;</span>)
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center left&#39;</span>, bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>), labels<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Real CTR A&#39;</span>, <span style="color:#e6db74">&#39;Real CTR B&#39;</span>, <span style="color:#e6db74">&#39;Calculated CTR A&#39;</span>, <span style="color:#e6db74">&#39;Calculated CTR B&#39;</span>])
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>set(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;No adaptation&#39;</span>, ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;$\mu$&#39;</span>, xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Ad Request Number&#39;</span>)

<span style="color:#75715e"># Epsilon - Greedy algorithm</span>
dg_eps <span style="color:#f92672">=</span> alg_comp_out_df \
    [[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>, <span style="color:#e6db74">&#39;muA_epsilon&#39;</span>, <span style="color:#e6db74">&#39;muB_epsilon&#39;</span>]] \
    <span style="color:#f92672">.</span>melt(id_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ad_request_num&#39;</span>) \
    <span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;variable&#39;</span>: <span style="color:#e6db74">&#39;Calculated CTR&#39;</span>})

ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>real_mean_a, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;grey&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>real_mean_b, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
sns<span style="color:#f92672">.</span>lineplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ad_request_num&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;value&#39;</span>, data<span style="color:#f92672">=</span>dg_eps, ax<span style="color:#f92672">=</span>ax[<span style="color:#ae81ff">1</span>], hue<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Calculated CTR&#39;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center left&#39;</span>, bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>), labels<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Real CTR A&#39;</span>, <span style="color:#e6db74">&#39;Real CTR B&#39;</span>, <span style="color:#e6db74">&#39;Calculated CTR A&#39;</span>, <span style="color:#e6db74">&#39;Calculated CTR B&#39;</span>])
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Epsilon - Greedy algorithm&#39;</span>, ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;$\mu$&#39;</span>, xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Ad Request Number&#39;</span>)

<span style="color:#75715e"># UCB1 algorithm</span>
dg_ucb1 <span style="color:#f92672">=</span> alg_comp_out_df \
    [[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>, <span style="color:#e6db74">&#39;muA_ucb1&#39;</span>, <span style="color:#e6db74">&#39;muB_ucb1&#39;</span>]] \
    <span style="color:#f92672">.</span>melt(id_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ad_request_num&#39;</span>) \
    <span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;variable&#39;</span>: <span style="color:#e6db74">&#39;Calculated CTR&#39;</span>})

ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>real_mean_a, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;grey&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>real_mean_b, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
sns<span style="color:#f92672">.</span>lineplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ad_request_num&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;value&#39;</span>, data<span style="color:#f92672">=</span>dg_ucb1, ax<span style="color:#f92672">=</span>ax[<span style="color:#ae81ff">2</span>], hue<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Calculated CTR&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center left&#39;</span>, bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>), labels<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Real CTR A&#39;</span>, <span style="color:#e6db74">&#39;Real CTR B&#39;</span>, <span style="color:#e6db74">&#39;Calculated CTR A&#39;</span>, <span style="color:#e6db74">&#39;Calculated CTR B&#39;</span>])
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>set(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;UCB1 algorithm&#39;</span>, ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;$\mu$&#39;</span>, xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Ad Request Number&#39;</span>)

<span style="color:#75715e"># Bayesian (Thompson) algorithm</span>
dg_bayesian <span style="color:#f92672">=</span> alg_comp_out_df \
    [[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>, <span style="color:#e6db74">&#39;muA_bayesian&#39;</span>, <span style="color:#e6db74">&#39;muB_bayesian&#39;</span>]] \
    <span style="color:#f92672">.</span>melt(id_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ad_request_num&#39;</span>) \
    <span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;variable&#39;</span>: <span style="color:#e6db74">&#39;Calculated CTR&#39;</span>})

ax[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>real_mean_a, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;grey&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
ax[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>axhline(y<span style="color:#f92672">=</span>real_mean_b, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>)
sns<span style="color:#f92672">.</span>lineplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ad_request_num&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;value&#39;</span>, data<span style="color:#f92672">=</span>dg_bayesian, ax<span style="color:#f92672">=</span>ax[<span style="color:#ae81ff">3</span>], hue<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Calculated CTR&#39;</span>)
ax[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center left&#39;</span>, bbox_to_anchor<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>), labels<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Real CTR A&#39;</span>, <span style="color:#e6db74">&#39;Real CTR B&#39;</span>, <span style="color:#e6db74">&#39;Calculated CTR A&#39;</span>, <span style="color:#e6db74">&#39;Calculated CTR B&#39;</span>])
ax[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>set(title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Bayesian (Thompson) algorithm&#39;</span>, ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;$\mu$&#39;</span>, xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Ad Request Number&#39;</span>)

plt<span style="color:#f92672">.</span>suptitle(<span style="color:#e6db74">&#39;Convergence of the Calculated CTR&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#ae81ff">1.02</span>, size<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;x-large&#39;</span>)
plt<span style="color:#f92672">.</span>tight_layout()
plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#39;plots/convergence_ctr.png&#39;</span>, dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>, bbox_inches<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tight&#39;</span>);
</code></pre></div><p><img src="blogpost_files/blogpost_41_0.svg" alt="svg"></p>
<p>We observe the following:</p>
<ul>
<li>No adaptation: one can clearly see that we had a random split 50%-50%, the behaviour of both ads is very similar and the CTR of both ads converge to their real one (after ca. 500 requests). For ad A in particular the convergence is farther to the real CTR compared to all the other algorithms (which agrees with what we have previously seen in the plots of the distributions).</li>
<li>Epsilon-Greedy: ad A is underperforming up to ca. 200 requests and it converges to real CTR after around 500 requests. The convergence of ad B is very similar to the no adaptation method, which stresses the fact we were mentioning before, that this Epsilon-Greedy algorithm is still showing ad B quite some times.</li>
<li>UCB1: while ad A converges with a speed similar to no adaptation, it does it much closer to the real CTR. On the other hand, ad B is being much less displayed, which we can see as it has a stairs shape.</li>
<li>Bayesian: convergence of ad A is very similar to UCB1 and the curve for ad B is basically flat, which seems to show that this is the method that has explored ad B the least.</li>
</ul>
<p>Below I include some stats for each method that validate the observations we have just seen in the plots.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">end_result <span style="color:#f92672">=</span> alg_comp_out_df<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>copy()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Method: No Adaptation&#39;</span>)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Views of A:&#39;</span>, end_result[<span style="color:#e6db74">&#39;viewsA_no_adapt&#39;</span>], 
    <span style="color:#e6db74">&#39;, Clicks on A:&#39;</span>, end_result[<span style="color:#e6db74">&#39;clicksA_no_adapt&#39;</span>], 
    <span style="color:#e6db74">&#39;, CTR:&#39;</span>, end_result[<span style="color:#e6db74">&#39;muA_no_adapt&#39;</span>], 
    <span style="color:#e6db74">&#39;, Real CTR A:&#39;</span>, real_mean_a)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Views of B:&#39;</span>, end_result[<span style="color:#e6db74">&#39;viewsB_no_adapt&#39;</span>], 
    <span style="color:#e6db74">&#39;, Clicks on B:&#39;</span>, end_result[<span style="color:#e6db74">&#39;clicksB_no_adapt&#39;</span>], 
    <span style="color:#e6db74">&#39;, CTR:&#39;</span>, end_result[<span style="color:#e6db74">&#39;muB_no_adapt&#39;</span>], 
    <span style="color:#e6db74">&#39;, Real CTR B:&#39;</span>, real_mean_b)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Total ads shown:&#39;</span>, end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], 
    <span style="color:#e6db74">&#39;, % A shown:&#39;</span>, round(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;viewsA_no_adapt&#39;</span>]<span style="color:#f92672">/</span>end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], <span style="color:#ae81ff">1</span>), 
    <span style="color:#e6db74">&#39;, % B shown:&#39;</span>, round(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;viewsB_no_adapt&#39;</span>]<span style="color:#f92672">/</span>end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], <span style="color:#ae81ff">1</span>))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Approximated number of lost clicks:&#39;</span>, 
    round(end_result[<span style="color:#e6db74">&#39;viewsB_no_adapt&#39;</span>]<span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;muA_no_adapt&#39;</span>]) <span style="color:#f92672">-</span> end_result[<span style="color:#e6db74">&#39;clicksB_no_adapt&#39;</span>]
)
</code></pre></div><pre><code>Method: No Adaptation
Views of A: 999.0 , Clicks on A: 529.0 , CTR: 0.53 , Real CTR A: 0.51
Views of B: 1046.0 , Clicks on B: 316.0 , CTR: 0.302 , Real CTR B: 0.31
Total ads shown: 2045.0 , % A shown: 48.9 , % B shown: 51.1
Approximated number of lost clicks: 238.0
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Method: Epsilon-Greedy&#39;</span>)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Views of A:&#39;</span>, end_result[<span style="color:#e6db74">&#39;viewsA_epsilon&#39;</span>], 
    <span style="color:#e6db74">&#39;, Clicks on A:&#39;</span>, end_result[<span style="color:#e6db74">&#39;clicksA_epsilon&#39;</span>], 
    <span style="color:#e6db74">&#39;, CTR:&#39;</span>, end_result[<span style="color:#e6db74">&#39;muA_epsilon&#39;</span>], 
    <span style="color:#e6db74">&#39;, Real CTR A:&#39;</span>, real_mean_a)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Views of B:&#39;</span>, end_result[<span style="color:#e6db74">&#39;viewsB_epsilon&#39;</span>], 
    <span style="color:#e6db74">&#39;, Clicks on B:&#39;</span>, end_result[<span style="color:#e6db74">&#39;clicksB_epsilon&#39;</span>], 
    <span style="color:#e6db74">&#39;, CTR:&#39;</span>, end_result[<span style="color:#e6db74">&#39;muB_epsilon&#39;</span>], 
    <span style="color:#e6db74">&#39;, Real CTR B:&#39;</span>, real_mean_b)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Total ads shown:&#39;</span>, end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], 
    <span style="color:#e6db74">&#39;, % A shown:&#39;</span>, round(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;viewsA_epsilon&#39;</span>]<span style="color:#f92672">/</span>end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], <span style="color:#ae81ff">1</span>), 
    <span style="color:#e6db74">&#39;, % B shown:&#39;</span>, round(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;viewsB_epsilon&#39;</span>]<span style="color:#f92672">/</span>end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], <span style="color:#ae81ff">1</span>))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Approximated number of lost clicks:&#39;</span>, 
    round(end_result[<span style="color:#e6db74">&#39;viewsB_epsilon&#39;</span>]<span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;muA_epsilon&#39;</span>]) <span style="color:#f92672">-</span> end_result[<span style="color:#e6db74">&#39;clicksB_epsilon&#39;</span>]
)
</code></pre></div><pre><code>Method: Epsilon-Greedy
Views of A: 1743.0 , Clicks on A: 905.0 , CTR: 0.519 , Real CTR A: 0.51
Views of B: 302.0 , Clicks on B: 87.0 , CTR: 0.288 , Real CTR B: 0.31
Total ads shown: 2045.0 , % A shown: 85.2 , % B shown: 14.8
Approximated number of lost clicks: 70.0
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Method: UCB1&#39;</span>)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Views of A:&#39;</span>, end_result[<span style="color:#e6db74">&#39;viewsA_ucb1&#39;</span>], 
    <span style="color:#e6db74">&#39;, Clicks on A:&#39;</span>, end_result[<span style="color:#e6db74">&#39;clicksA_ucb1&#39;</span>], 
    <span style="color:#e6db74">&#39;, CTR:&#39;</span>, end_result[<span style="color:#e6db74">&#39;muA_ucb1&#39;</span>], 
    <span style="color:#e6db74">&#39;, Real CTR A:&#39;</span>, real_mean_a)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Views of B:&#39;</span>, end_result[<span style="color:#e6db74">&#39;viewsB_ucb1&#39;</span>], 
    <span style="color:#e6db74">&#39;, Clicks on B:&#39;</span>, end_result[<span style="color:#e6db74">&#39;clicksB_ucb1&#39;</span>], 
    <span style="color:#e6db74">&#39;, CTR:&#39;</span>, end_result[<span style="color:#e6db74">&#39;muB_ucb1&#39;</span>], 
    <span style="color:#e6db74">&#39;, Real CTR B:&#39;</span>, real_mean_b)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Total ads shown:&#39;</span>, end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], 
    <span style="color:#e6db74">&#39;, % A shown:&#39;</span>, round(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;viewsA_ucb1&#39;</span>]<span style="color:#f92672">/</span>end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], <span style="color:#ae81ff">1</span>), 
    <span style="color:#e6db74">&#39;, % B shown:&#39;</span>, round(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;viewsB_ucb1&#39;</span>]<span style="color:#f92672">/</span>end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], <span style="color:#ae81ff">1</span>))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Approximated number of lost clicks:&#39;</span>, 
    round(end_result[<span style="color:#e6db74">&#39;viewsB_ucb1&#39;</span>]<span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;muA_ucb1&#39;</span>]) <span style="color:#f92672">-</span> end_result[<span style="color:#e6db74">&#39;clicksB_ucb1&#39;</span>]
)
</code></pre></div><pre><code>Method: UCB1
Views of A: 1911.0 , Clicks on A: 977.0 , CTR: 0.511 , Real CTR A: 0.51
Views of B: 134.0 , Clicks on B: 35.0 , CTR: 0.261 , Real CTR B: 0.31
Total ads shown: 2045.0 , % A shown: 93.4 , % B shown: 6.6
Approximated number of lost clicks: 33.0
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Method: Bayesian&#39;</span>)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Views of A:&#39;</span>, end_result[<span style="color:#e6db74">&#39;viewsA_bayesian&#39;</span>], 
    <span style="color:#e6db74">&#39;, Clicks on A:&#39;</span>, end_result[<span style="color:#e6db74">&#39;clicksA_bayesian&#39;</span>], 
    <span style="color:#e6db74">&#39;, CTR:&#39;</span>, end_result[<span style="color:#e6db74">&#39;muA_bayesian&#39;</span>], 
    <span style="color:#e6db74">&#39;, Real CTR A:&#39;</span>, real_mean_a)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Views of B:&#39;</span>, end_result[<span style="color:#e6db74">&#39;viewsB_bayesian&#39;</span>], 
    <span style="color:#e6db74">&#39;, Clicks on B:&#39;</span>, end_result[<span style="color:#e6db74">&#39;clicksB_bayesian&#39;</span>], 
    <span style="color:#e6db74">&#39;, CTR:&#39;</span>, end_result[<span style="color:#e6db74">&#39;muB_bayesian&#39;</span>], 
    <span style="color:#e6db74">&#39;, Real CTR B:&#39;</span>, real_mean_b)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Total ads shown:&#39;</span>, end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], 
    <span style="color:#e6db74">&#39;, % A shown:&#39;</span>, round(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;viewsA_bayesian&#39;</span>]<span style="color:#f92672">/</span>end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], <span style="color:#ae81ff">1</span>), 
    <span style="color:#e6db74">&#39;, % B shown:&#39;</span>, round(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;viewsB_bayesian&#39;</span>]<span style="color:#f92672">/</span>end_result[<span style="color:#e6db74">&#39;ad_request_num&#39;</span>], <span style="color:#ae81ff">1</span>))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Approximated number of lost clicks:&#39;</span>, 
    round(end_result[<span style="color:#e6db74">&#39;viewsB_bayesian&#39;</span>]<span style="color:#f92672">*</span>end_result[<span style="color:#e6db74">&#39;muA_bayesian&#39;</span>]) <span style="color:#f92672">-</span> end_result[<span style="color:#e6db74">&#39;clicksB_bayesian&#39;</span>]
)
</code></pre></div><pre><code>Method: Bayesian
Views of A: 1999.0 , Clicks on A: 1014.0 , CTR: 0.507 , Real CTR A: 0.51
Views of B: 46.0 , Clicks on B: 9.0 , CTR: 0.196 , Real CTR B: 0.31
Total ads shown: 2045.0 , % A shown: 97.8 , % B shown: 2.2
Approximated number of lost clicks: 14.0
</code></pre>
<h2 id="final-remarks">Final remarks</h2>
<h3 id="more-variants-and-more-experiments">More variants and more experiments</h3>
<p>Note that the implementations are assuming we are experimenting with only 2 variants, but it would not be hard to generalize it to a higher number of variants. May be nice to have the code flexible to work with arbitrary number of variants.</p>
<p>In any case, if one wants to experiment with other values of Real CTR&rsquo;s, the code is abstract enough to run all at once just by changing the values at the beginning of this post.</p>
<h3 id="more-algorithms">More algorithms</h3>
<p>There are more algorithms out there to deal with the Explore-Exploit Dilemma. When searching for them you can certainly find them looking for multi-bandit problems (instead of displaying ads, you play slot machines). Here I leave a link to an example of a <a href="https://jamesrledoux.com/algorithms/bandit-algorithms-epsilon-ucb-exp-python/">nice blogpost with more algorithms</a> from James LeDoux&rsquo;s blog.</p>
<h3 id="when-can-i-stop-gathering-data-for-my-experiment">When can I stop gathering data for my experiment?</h3>
<p>This is the million €€ question. The literature around this topic is really confusing and I don&rsquo;t want to add more confusion to your bag. This is why I am skipping this topic in this post. I personally find interesting this <a href="https://www.chrisstucchio.com/blog/2014/bayesian_ab_decision_rule.html">post from Chris Stucchio&rsquo;s blog</a> but I need to find time to read it carefully.</p>
<h3 id="canary-releases">Canary releases</h3>
<p>A/B testing has some similarities to <a href="https://martinfowler.com/bliki/CanaryRelease.html">Canary releases</a>. A Canary release consists of releasing for example a new version of your software, showing it only to a fraction of your users and gradually incrementing the flow when you confirm the new version is behaving &ldquo;well&rdquo; (where &ldquo;well&rdquo; may just mean that it is stable, or maybe your goal is that conversions of some kind improve,&hellip;) so that if there is any issue, you can rollback to the old version easily. Despite its similarities, I find it is a different technique, usually for different purposes, for example:</p>
<ul>
<li>
<p>Imagine you update your website from some programing language version v2.x to version 3.y. This is something you want to do because it is best practise, but don&rsquo;t necessarily mean you want to improve conversions or revenue (of course we would all love that but it is not the main goal of this task). In this case you would use a Canary release.</p>
</li>
<li>
<p>For A/B testing you need to set a goal, for example &ldquo;improve CTR of my landing page 3%&rdquo; or &ldquo;reduce bounce rate 2%&rdquo; and generally it is good practise to make only one change at the time yo that you can attribute the improvement to that change.</p>
</li>
</ul>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="../../../index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="../../../images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="../../../js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-132832089-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

